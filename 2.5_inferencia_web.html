<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>C√°mara ‚Üí API Inferencia</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bulma CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
<script>
/***********************
 CONFIGURATION
************************/
const API_URL = "http://20.40.210.148:5001/infer";

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const resultImage = document.getElementById("resultImage");
const resultsBox = document.getElementById("results");
const btn = document.getElementById("btnCapture");

/***********************
 ACTIVE CAMERA
************************/
navigator.mediaDevices.getUserMedia({ video: true })
.then(stream => {
    video.srcObject = stream;
})
.catch(err => {
    alert("‚ùå No se pudo acceder a la c√°mara: " + err);
});

/***********************
 FUNCTION
************************/
async function captureAndSend() {

    const w = video.videoWidth;
    const h = video.videoHeight;

    if (!w || !h) {
        alert("‚ö†Ô∏è La c√°mara a√∫n no est√° lista");
        return;
    }

    canvas.width = w;
    canvas.height = h;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, w, h);

    // Base64 limpio
    const base64Image = canvas
        .toDataURL("image/png")
        .replace("data:image/png;base64,", "");

    const payload = {
        id_equipo: "WEB_CAM",
        image_base64: base64Image,
        retorno_imagen: "SI"
    };

    resultsBox.textContent = "‚è≥ Enviando imagen...";

    try {
        const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        // Resultados
        let text = "";
        if (data.results) {
            for (const key in data.results) {
                text += `${key.toUpperCase()}: ${data.results[key].toFixed(1)} %\n`;
            }
        } else {
            text = JSON.stringify(data, null, 2);
        }
        resultsBox.textContent = text;

        // Imagen procesada
        if (data.imagen_base64) {
            resultImage.src = "data:image/png;base64," + data.imagen_base64;
        }

    } catch (err) {
        resultsBox.textContent = "‚ùå Error API:\n" + err;
        console.error(err);
    }
}

/***********************
 EVENT BUTTON
************************/
btn.addEventListener("click", captureAndSend);
</script>
<style>
body {
    background: #0f0f0f;
}

.video-box video,
.video-box img {
    width: 100%;
    border-radius: 10px;
    border: 2px solid #2f2f2f;
}

pre {
    background: #111;
    color: #00ffae;
    padding: 10px;
    border-radius: 8px;
    font-size: 0.9rem;
    overflow-x: auto;
}
</style>
</head>

<body>

<section class="section">
<div class="container">

    <!-- Header -->
    <h1 class="title has-text-centered has-text-light">
        üì∑ C√°mara ‚Üí API Inferencia
    </h1>
    <p class="subtitle has-text-centered has-text-grey-light">
        Captura desde navegador y env√≠o directo al API
    </p>

    <!-- Grid -->
    <div class="columns is-multiline">

        <!-- C√°mara -->
        <div class="column is-12-tablet is-6-desktop">
            <div class="box has-background-dark video-box">
                <h3 class="title is-5 has-text-light">üé• C√°mara</h3>
                <video id="video" autoplay playsinline></video>

                <div class="has-text-centered mt-4">
                    <button id="btnCapture" class="button is-primary is-medium is-fullwidth">
                        üì∏ Capturar & Enviar
                    </button>
                </div>
            </div>
        </div>

        <!-- Imagen procesada -->
        <div class="column is-12-tablet is-6-desktop">
            <div class="box has-background-dark video-box">
                <h3 class="title is-5 has-text-light">üñº Imagen Procesada</h3>
                <img id="resultImage">
            </div>
        </div>

        <!-- Resultados -->
        <div class="column is-12">
            <div class="box has-background-dark">
                <h3 class="title is-5 has-text-light">üìä Resultados</h3>
                <pre id="results">Esperando captura...</pre>
            </div>
        </div>

    </div>
</div>
</section>

<canvas id="canvas" style="display:none;"></canvas>



</body>
</html>
