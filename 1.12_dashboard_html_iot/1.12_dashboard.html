<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IoT Dashboard</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
canvas { margin-top: 20px; }
</style>
</head>

<body class="has-background-light">

<section class="section">
<div class="container">

<h1 class="title has-text-centered">ðŸ“¡ IoT Dashboard - Laboratorio Kingsoft</h1>

<div class="tabs is-boxed is-centered">
  <ul>
    <li class="is-active" data-tab="latest"><a>Latest Reading</a></li>
    <li data-tab="charts"><a>Charts</a></li>
  </ul>
</div>

<!-- ================= LATEST READING ================= -->
<div id="latest" class="tab-content">

  <div class="has-text-right mb-3">
    <button class="button is-link is-small" onclick="loadLatest()">
      ðŸ”„ Refresh
    </button>
  </div>

  <div class="columns is-multiline" id="latestCards"></div>
</div>

<!-- ================= CHARTS ================= -->
<div id="charts" class="tab-content" style="display:none">

  <div class="columns">
    <div class="column is-3">
      <label class="label">ðŸ“Š Variable</label>
      <div class="select is-fullwidth">
        <select id="variableSelect">
          <option value="temperature">Temperature</option>
          <option value="humidity">Humidity</option>
          <option value="lux">Lux</option>
          <option value="noise_level">Noise Level</option>
          <option value="co_ppm">CO (ppm)</option>
          <option value="accel_x">Accel X</option>
          <option value="accel_y">Accel Y</option>
          <option value="accel_z">Accel Z</option>
        </select>
      </div>
    </div>

    <div class="column is-3">
      <label class="label">ðŸ“… Start Date</label>
      <input id="startDate" class="input" type="date">
    </div>

    <div class="column is-3">
      <label class="label">ðŸ“… End Date</label>
      <input id="endDate" class="input" type="date">
    </div>

    <div class="column is-3">
      <label class="label">&nbsp;</label>
      <button class="button is-link is-fullwidth" onclick="loadRangeData()">
        Apply Filter
      </button>
    </div>
  </div>

  <div class="box">
    <canvas id="chart"></canvas>
  </div>

</div>

</div>
</section>

<script>
const API = "http://20.40.210.148:5000/api";
let chart;

// ================== TABS ==================
document.querySelectorAll(".tabs li").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tabs li").forEach(t => t.classList.remove("is-active"));
    tab.classList.add("is-active");
    document.querySelectorAll(".tab-content").forEach(c => c.style.display = "none");
    document.getElementById(tab.dataset.tab).style.display = "block";
  });
});

// ================== LATEST READING ==================
async function loadLatest() {
  const res = await fetch(`${API}/readings/latest`);
  const data = await res.json();

  const container = document.getElementById("latestCards");
  container.innerHTML = "";

  Object.entries(data).forEach(([key, value]) => {
    if (key === "id" || key === "device_id") return;

    container.innerHTML += `
      <div class="column is-3">
        <div class="card">
          <div class="card-content has-text-centered">
            <p class="heading">${key}</p>
            <p class="title is-5">${value}</p>
          </div>
        </div>
      </div>
    `;
  });
}

// ================== RANGE DATA ==================
async function loadRangeData() {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;

  if (!start || !end) {
    alert("Please select both dates");
    return;
  }

  const res = await fetch(
    `${API}/readings/range?start_date=${start}&end_date=${end}`
  );
  const data = await res.json();

  renderChart(data);
}

// ================== CHART ==================
function renderChart(data) {
  const variable = document.getElementById("variableSelect").value;

  if (chart) chart.destroy();

  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      labels: data.map(r => r.timestamp),
      datasets: [{
        label: variable,
        data: data.map(r => r[variable]),
        borderWidth: 2,
        fill: false
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          ticks: { maxRotation: 45 }
        }
      }
    }
  });
}

// ================== INIT ==================
loadLatest();
</script>

</body>
</html>
